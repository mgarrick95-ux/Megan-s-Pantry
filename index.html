<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <meta name="theme-color" content="#4f46e5" />
  <title>FrostPantry</title>
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --ink:#111827; --muted:#6b7280; --primary:#4f46e5; --border:#e5e7eb; --red:#fee2e2; --red-text:#b91c1c; --orange:#ffedd5; --orange-text:#9a3412; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    h1{font-size:1.25rem;margin:0}
    .muted{color:var(--muted); font-size:0.9rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,0.04);margin-bottom:12px}
    label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:4px}
    input[type=text],input[type=date],select,textarea{width:100%;border:1px solid var(--border);padding:10px;border-radius:10px;background:#fff}
    .row{display:grid;gap:10px}
    @media(min-width:640px){.grid-6{grid-template-columns:2fr 2fr 1fr 1.2fr 1.5fr 1.5fr}.grid-4{grid-template-columns:2fr 1fr 1fr 1fr}}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;font-size:.95rem}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.sm{padding:4px 8px;font-size:.85rem}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left} th{font-size:.85rem;color:var(--muted)}
    tr.zero{background:var(--red);color:var(--red-text)} tr.low{background:var(--orange);color:var(--orange-text)}
    .qty-controls{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .qty-controls button{border:none;background:#f3f4f6;padding:8px 12px;font-size:1.1rem}
    .qty-controls input{width:70px;border:none;text-align:center;padding:8px;font-size:1.05rem}
    .status{position:sticky;top:0;z-index:10;margin:-8px -8px 8px -8px;padding:8px 12px;border-radius:0 0 12px 12px;background:#eef2ff;color:#3730a3;font-size:.9rem;border:1px solid #c7d2fe;display:none}
    .mobile-hide{display:none}@media(min-width:640px){.mobile-hide{display:table-cell}}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header><h1>FrostPantry</h1></header>
    <div id="status" class="status"></div>
    <div class="muted" style="margin-bottom:10px">Installable & offline. Tap <b>Use 1</b> or <b>Add 1</b> on any row to update quantity.</div>

    <section class="card">
      <form id="form" class="row grid-6">
        <div><label>Category</label>
          <select id="category"><option>Pantry</option><option>Deep Freeze</option><option>Freezer (bottom)</option><option>Fridge</option></select>
        </div>
        <div><label>Item</label><input id="item" type="text" required placeholder="e.g., Tomato sauce" /></div>
        <div><label>Quantity</label>
          <div class="qty-controls">
            <button type="button" id="dec">−</button>
            <input id="qty" type="text" inputmode="numeric" pattern="[0-9]*" value="1" />
            <button type="button" id="inc">+</button>
          </div>
        </div>
        <div><label>Unit</label>
          <select id="unit"><option>packs</option><option>boxes</option><option>jars</option><option>bags</option><option>cans</option><option>lbs</option><option>each</option><option>cubes</option></select>
        </div>
        <div><label>Date Added</label><input id="added" type="date" /></div>
        <div><label>Expiry</label><input id="expiry" type="date" /></div>
        <div style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="2" placeholder="e.g., Use first"></textarea></div>
        <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:flex-start">
          <button class="btn primary" type="submit">Add item</button>
          <button class="btn" id="export" type="button">Export CSV</button>
          <input type="file" id="importFile" accept=".csv" style="display:none" />
          <button class="btn" id="import" type="button">Import CSV</button>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="row grid-4" style="margin-bottom:8px">
        <div><label>Search</label><input id="search" type="text" placeholder="Item, notes, unit…"/></div>
        <div><label>Filter: Category</label>
          <select id="filterCategory"><option>All</option><option>Pantry</option><option>Deep Freeze</option><option>Freezer (bottom)</option><option>Fridge</option></select>
        </div>
        <div><label>Filter: Stock</label>
          <select id="filterStock"><option>All</option><option>Low (≤1)</option><option>Zero (0)</option></select>
        </div>
        <div><label>Sort by</label>
          <select id="sortBy"><option value="category">Category</option><option value="item">Item</option><option value="qty">Quantity</option><option value="expiry">Expiry</option><option value="added">Date Added</option></select>
        </div>
        <div style="grid-column:1/-1;display:flex;justify-content:flex-end"><button class="btn" id="resetFilters" type="button">Reset filters</button></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Category</th><th>Item</th><th>Qty</th><th>Unit</th><th class="mobile-hide">Date Added</th><th class="mobile-hide">Expiry</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); });
    }
    const STORAGE_KEY = 'frostpantry_rows_v_pages';
    const statusEl = document.getElementById('status');
    function flash(msg){ statusEl.textContent = msg; statusEl.style.display = 'block'; clearTimeout(flash._t); flash._t = setTimeout(()=> statusEl.style.display='none', 1500); }
    const fields = { category: document.getElementById('category'), item: document.getElementById('item'), qty: document.getElementById('qty'), unit: document.getElementById('unit'), added: document.getElementById('added'), expiry: document.getElementById('expiry'), notes: document.getElementById('notes') };
    const btnDec = document.getElementById('dec'); const btnInc = document.getElementById('inc'); const tbody = document.getElementById('tbody');
    const filterEls = { q: document.getElementById('search'), category: document.getElementById('filterCategory'), stock: document.getElementById('filterStock'), sort: document.getElementById('sortBy'), reset: document.getElementById('resetFilters') };
    let rows = []; try { rows = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){ rows = []; }

    function sanitizeQtyInput(el){ const digits = (el.value||'').replace(/[^0-9]/g,''); el.value = digits === '' ? '0' : String(parseInt(digits,10)); }
    fields.qty.addEventListener('input', ()=> sanitizeQtyInput(fields.qty)); fields.qty.addEventListener('change', ()=> sanitizeQtyInput(fields.qty));
    function holdRepeat(el, fn){ let t, r; const start=()=>{ fn(); t=setTimeout(()=>{ r=setInterval(fn,80); },350); }; const stop=()=>{ clearTimeout(t); clearInterval(r); };
      el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive:true}); ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> el.addEventListener(ev, stop)); }
    holdRepeat(btnDec, ()=> { fields.qty.value = String(Math.max(0, Number(fields.qty.value||0) - 1)); });
    holdRepeat(btnInc, ()=> { fields.qty.value = String(Math.max(0, Number(fields.qty.value||0) + 1)); });

    function esc(s){ return String(s||'').replace(/[&<>'\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c] || c)); }

    function render(){
      let xs = rows.map((r, idx) => ({...r, _idx: idx}));
      const q = (filterEls.q.value||'').toLowerCase();
      const cat = filterEls.category.value;
      const stock = filterEls.stock.value;
      const sortBy = filterEls.sort.value;
      if (q) xs = xs.filter(r => [r.item,r.notes,r.category,r.unit].some(v => (v||'').toLowerCase().includes(q)));
      if (cat !== 'All') xs = xs.filter(r => r.category === cat);
      if (stock === 'Low (≤1)') xs = xs.filter(r => Number(r.qty) <= 1);
      if (stock === 'Zero (0)') xs = xs.filter(r => Number(r.qty) === 0);
      xs.sort((a,b)=>{
        switch (sortBy){
          case 'item': return a.item.localeCompare(b.item);
          case 'qty': return Number(a.qty)-Number(b.qty);
          case 'expiry': { const ad=a.expiry?new Date(a.expiry).getTime():Infinity; const bd=b.expiry?new Date(b.expiry).getTime():Infinity; return ad-bd; }
          case 'added': { const ad=a.added?new Date(a.added).getTime():Infinity; const bd=b.added?new Date(b.added).getTime():Infinity; return ad-bd; }
          default: return a.category.localeCompare(b.category) || a.item.localeCompare(b.item);
        }
      });
      tbody.innerHTML = xs.length ? xs.map(r => {
        const cls = r.qty===0 ? 'zero' : (r.qty<=1 ? 'low' : '');
        return `<tr class="${cls}">
          <td>${esc(r.category)}</td>
          <td>${esc(r.item)}</td>
          <td>${esc(r.qty)}</td>
          <td>${esc(r.unit)}</td>
          <td class="mobile-hide">${esc(r.added||'')}</td>
          <td class="mobile-hide">${esc(r.expiry||'')}</td>
          <td>${esc(r.notes||'')}</td>
          <td>
            <div class="actions">
              <button class="btn sm" data-action="use1" data-idx="${r._idx}">Use 1</button>
              <button class="btn sm" data-action="add1" data-idx="${r._idx}">Add 1</button>
            </div>
          </td>
        </tr>`;
      }).join('') : '<tr><td colspan="8" class="muted">No items yet. Add one above.</td></tr>';
    }

    function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }

    // Initial render
    render();

    // Add item handler
    document.getElementById('form').addEventListener('submit', (e)=>{
      e.preventDefault(); sanitizeQtyInput(fields.qty);
      const rec = {
        category: fields.category.value,
        item: fields.item.value.trim(),
        qty: Math.max(0, Number(fields.qty.value||0)),
        unit: fields.unit.value,
        added: fields.added.value,
        expiry: fields.expiry.value,
        notes: fields.notes.value.trim()
      };
      if (!rec.item) { flash('Please enter an item name'); fields.item.focus(); return; }
      rows.unshift(rec); persist(); render(); flash('Item added ✓');
      fields.item.value=''; fields.qty.value='1'; fields.notes.value='';
    });

    // Actions: Use 1 / Add 1
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const idx = Number(btn.getAttribute('data-idx'));
      const action = btn.getAttribute('data-action');
      if (Number.isNaN(idx) || !rows[idx]) return;

      if (action === 'use1') {
        if (rows[idx].qty <= 0) { flash('Already at 0'); return; }
        rows[idx].qty = Math.max(0, Number(rows[idx].qty||0) - 1);
        persist(); render(); flash('Used 1 ✓');
      } else if (action === 'add1') {
        rows[idx].qty = Math.max(0, Number(rows[idx].qty||0) + 1);
        persist(); render(); flash('Added 1 ✓');
      }
    });

    // Filters & sorting
    document.getElementById('search').addEventListener('input', render);
    ['filterCategory','filterStock','sortBy'].forEach(id => document.getElementById(id).addEventListener('change', render));
    document.getElementById('resetFilters').addEventListener('click', ()=>{
      document.getElementById('search').value='';
      document.getElementById('filterCategory').value='All';
      document.getElementById('filterStock').value='All';
      document.getElementById('sortBy').value='category';
      render();
    });

    // Helpers for qty input
    document.getElementById('dec').addEventListener('click', ()=>{
      fields.qty.value = String(Math.max(0, Number(fields.qty.value||0) - 1));
    });
    document.getElementById('inc').addEventListener('click', ()=>{
      fields.qty.value = String(Math.max(0, Number(fields.qty.value||0) + 1));
    });
  </script>
</body>
</html>
